---
title: 基于 Semtech SX1280 2.4GHz LoRa 的无 GPS 地理定位研究
published: 2025-10-03
description: '记一次中外合办的本科生暑期科研项目'
image: ''
tags: [IOT, WSN, RF, LoRa]
category: 'Research'
draft: false 
lang: ''
---

据学长介绍，以往这一类型的科研都是室内定位，基于Wi-Fi，无线AP这些，今年（2025年）是第一年将这类研究搬到室外的。教授提出的难点就是，用一般的TOF飞行时间算法，因为光速很快，所以对MCU的主频要求很高，主频低的话，比如最小精确到1微秒，光都走了300米了，会导致误差很大。原本的想法比较寻常，找一颗普通的LoRa芯片，例如Semtech的SX1276，1278，（他俩支持的频段不一样），采集不同点位收发数据时的RSSI，LQI等数据，相当于指纹信息，交给神经网络处理，再结合温湿度等信息，得到较为准确的距离值（btw，此处存疑，身为做硬件的是真的无法理解这个黑盒如何给出准确距离hhhh）。从距离得到位置需要更多节点，作为后续研究。

那么在实际选型时，我们发现Semtech的一个新品SX1280自带测距功能，其特点就是SX1280能直接给出距离（好像是通过SPI），那就是与MCU主频无关了，只要一颗MCU与SX1280通信，告诉它什么时候开始测量，以及读出测量值就行了。唯一到现在还不是很理解的点是，SX1280称它芯片内置的测距算法也是TOF，而SX1280的主频整个datasheet也没写，只知道收发的LoRa频率是2.4GHz，但是我感觉主频不太可能跟CPU一样到1GHz以上，教授也是研究了好久，最后说这是**RF-TOF**，跟普通的Packet-level TOF不一样，与芯片主频无关，但是到现在我还是不理解它为什么能较为精确地定位，这个RF-TOF网上的相关资料也基本没有，不明白。

此处附上Semtech的SX1280官方页面，官方还专门提供了一个文档解释该芯片的TOF测距原理：
https://www.semtech.com/products/wireless-rf/lora-connect/sx1280

后续就是一位同学画了板子，用STM32G4的单片机去读SX1280模块，但是他设计的板子依旧是串口输出，在烈日下带电脑或手机采集数据还是较为不便，于是我使用了一块ESP32开发板，让他把串口数据传给我，实现了Wi-Fi同步ntp时间，串口采集数据并保存到SPIFFS，读取ESP32模块外接的AHT20温湿度模块测量值，以及web页面供实时查看和管理数据文件的功能。

不过我们的问题就处在用了SX1280模块的问题上。一般常见的SX1280模块仅有SX1280芯片以及外部晶振和射频前端匹配电容电感这些必要元器件，但是我们选用的**亿佰特E280-2G4T12S**模块过于定制化，它会直接通过串口输出处理过后的距离值，并仅能通过外部引脚控制SX1280的极少功能（工作模式），意味着其模块屏蔽罩内部已经封装了一颗单片机，并且程序和电路闭源，我们无法直接控制SX1280底层以获取RSSI等信息。

此处附上亿佰特E280-2G4T12S模块的网站：
https://www.ebyte.com/product/1510.html

负责神经网络的同学最终结果也不尽如人意，但这块我确实不懂。

另外教授最后说明，他原本想要实现10-15公里，及一个城市内部的基于LoRa的定位，而我们这次仅局限于操场，另外运行在2.4GHz这么高频率上的LoRa也是绝对不可能有如此远的传输距离的。以及教授希望这个实验能被任何人复刻，所以不希望我们用自己设计的pcb，而是用现成的开发板。结合这几点改进方案，我们下次可能还是会换回原始方案，基于sub-1GHz的SX1276，78的lilygo或者heltec的开发板，并采集RSSI等数据进行分析。

最后附上教授对此研究的博客链接：
https://kyeongsoo.github.io/research/projects/surf-20250217/index.html

---

## 附录：项目官方介绍：

**Abstract for Non-Specialists (150 words):**

In WSN/IoT, the localization of nodes are essential to long-running applications for accurate environment monitoring and detection of important events, often covering a large area in the field. Due to the lower time resolution of typical WSN/IoT platforms (e.g., 1 microsecond for ESP32), ranging-based localization techniques cannot provide spatial resolution better than ~300 meters. Location fingerprinting techniques based on received signal strengths, too, suffer from various scattering issues, resulting in lower performance. In this project, we are to investigate hybrid localization techniques based on both ranging and location fingerprinting, where the lower spatial resolution from ranging could be improved by (1) a newly-proposed "multiple two-way message exchanges" scheme and (2) location fingerprinting based on received signal strengths and a time series of measurement data like the arrival times of periodic beacons. We will carry out experiments on a LoRa testbed to demonstrate the feasibility of GPS-free geolocation based on the hybrid localization techniques.

**Student Learning Outcomes and Benefits to Students (200 words):**

The students completing the project should be able to:
- Understand localization based on location fingerprinting and machine learning techniques (e.g., neural networks or Gaussian processes).
- Understand LoRa technology and its protocols.
- Have experience in embedded programming.
- Acquire an ability to carry out experiments and analyse the resulting data.

**Requirements for students in this project (Pre-requisites, skills and location of the students (100 words):**

The students should:
- Be required to stay in Suzhou during the project.
- Have good knowledge of WSN/IoT.
- Have experience in embedded programming on platforms like Arduino, ESP32, or STM32.

---

## 附录：我们合作撰写的实验简介：

# XJTLU-SURF-2025-0217

# TOF-Based Outdoor Relative Positioning Experiment

## Overview
Due to the lower time resolution or low clock frequency of typical WSN/IoT platforms (e.g., 1 microsecond for ESP32), traditional **TOF (Time of Flight)** cannot provide spatial resolution better than ~300 meters. This project presents a controlled outdoor relative positioning experiment based on **RF-TOF (Radio Frequency - Time of Flight)** positioning, conducted on the school playground. The open outdoor environment provides an ideal measurement setting.

**Important:** Only Semtech SX1280/SX1282 support **chip-level** TOF (RF-TOF). RF-TOF is different from traditional TOF and does not rely on clock frequency of MCU, and these two provide LoRa in the 2.4GHz band, higher than Sub-1GHz.

We selected a **50m × 50m** area and divided it into **25 grids**, each with an area of **100 m²** and a grid length of **10 meters**. The entire area contains **36 intersection points**, which serve as reference points for positioning.

---

## Experimental Setup

### Reference Points
- **Number of points:** 36 intersection points.
- **Placement:** Anchors will be placed at these points, each equipped with a LoRa Slave node.
- **Playground advantages:** White painted lines marking 90° angles will help with accurate calibration.
- **Coordinate mapping:**  
  - Horizontal axis → **X-axis**  
  - Vertical axis → **Y-axis**  
- **Anchor marking:** Ground-marked with high-strength adhesive tape for stability.
  
---
### Data Usage
The data collected from all reference points will be used for **training** and **validation**.

---

## Base Station Setup
- **Location:** Outside anchor points to avoid interference (e.g., shot put throwing zone).
- **Coordinate system:** Base station positioned at the origin, but outside the measurement area (the 25 grids).
- **Hardware:**
  - **Custom-designed PCB** based on **SX1280** module and **STM32G4** MCU.
  - Connected to **ESP32** for data acquisition and transmission. (Wemos-D1-mini ESP-WROOM-32)
  - Identical hardware to reference points, except:
    - Base station connects to ESP32 via serial, ESP32 sync time from NTP server and fetch time and humidity from AHT20 whenever data is received by serial port.
    - Nodes have GPS modules, base station doesn't.

---
### Communication & Data Flow
- **Distance Measurement:** RF-TOF between base station and nodes.
- **Serial Data Format: ID, Distance, GPS**  
- **Real-time display:** Web page showing measurement process, network status, and data transmission.
- **Data Storage:** CSV files for training & validation.
- **Additional Transmission:** MQTT to vendor server for monitoring anomalies.


---

## Measurement Process
- **Laser distance meter:** Used to measure true distances (Y values).
- **TOF data:** Collected from LoRa nodes (X values) for dataset creation.
- **GPS Accuracy:**  
- GPS deviation must be within 5 meters; otherwise, relative coordinates are added manually.  
- GPS data converted into the relative coordinate system.
- **Satellite positioning factors:** Number of satellites may affect results.

---

## Temperature & Environmental Considerations
- **Temperature impact:**  
- TOF measurement drift.  
- Frequency fluctuations in crystal oscillator.  
- Increased measurement errors.
- **Compensation Strategies:**
- Crystal oscillator compensation.
- Adjusting data collection order to balance temperature effects.
- **Temperature & Humidity Sensors:**
- Installed on both base station and node boards.　(Recently only ESP32 equips sensor.)
- Real-time transmission to PC.
- Extended serial format:  
  ```
  ID, Distance, GPS Coordinates, Base Station Temperature, Node Temperature
  ```
- **Future Calibration:** Relationship between TOF error and temperature will be studied.

---

## Data Collection Procedure
1. Select **3 reference points** per measurement.
2. Place Slave nodes at these points.
3. Base station polls nodes every **10 seconds**.
4. Repeat cycle **10–20 times**.
5. Save each result as CSV.
6. Convert GPS data to relative coordinates.
7. Total samples: **360**.
8. Split data: **80% training / 20% validation**.

---

## Summary
This experiment combines:
- **RF TOF Technology**
- **LoRa Communication**
- **STM32 & ESP32 embedded programming**
- **Temperature & Humidity Sensing**
- **Machine Learning Model Training**

The aim is to **enhance the precision and robustness** of relative position measurements.

**Note:** In this updated experiment, we are now using only **9 reference points** and **GPS has been removed** from the setup.
---